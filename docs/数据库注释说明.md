# Motify 数据库表结构中文注释说明

## 概述
已为 motify_2.sql 文件中的所有数据库对象添加了详细的中文注释，包括：
- 9个数据表的完整注释
- 所有字段的用途说明
- 索引的性能优化说明
- 外键约束的数据完整性说明
- 触发器的业务逻辑说明

## 数据表注释详情

### 1. 管理员表 (admins)
**用途**: 存储系统管理员的基本信息和登录凭据
**关键字段**:
- `admin_id`: 管理员ID，主键，自增
- `username`: 登录用户名，带唯一索引
- `password`: 已加密存储的密码
- `is_active`: 账户激活状态
- `last_login_time`: 追踪管理员活跃度

### 2. 汽车表 (cars)
**用途**: 存储用户车辆信息，支持一个用户拥有多辆车
**关键字段**:
- `car_id`: 汽车ID，主键
- `license_plate`: 车牌号，唯一约束
- `user_id`: 外键关联车主
**索引优化**: 车牌号唯一索引，用户ID普通索引

### 3. 维修项目-维修人员关联表 (item_repairman)
**用途**: 多对多关系表，记录维修项目分配给哪些维修人员
**关键字段**:
- `is_accepted`: 维修人员是否接受此工单
**业务逻辑**: 支持工单分配和接受状态管理

### 4. 维修项目表 (maintenance_items)
**用途**: 存储汽车维修工单的完整生命周期信息
**关键字段**:
- `status`: 维修状态（PENDING/ACCEPTED/CANCELLED/IN_PROGRESS/COMPLETED）
- `cost`: 维修总费用（由触发器自动计算）
- `labor_cost`: 工时费用
- `material_cost`: 材料费用
- `progress`: 维修进度百分比
- `score`: 用户评分

### 5. 维修记录表 (maintenance_records)
**用途**: 记录每个维修人员在每个工单上的具体工作内容和时长
**关键字段**:
- `work_hours`: 工作时长，用于计算工时费
- `repair_man_id`: 执行维修的人员ID
**计费逻辑**: 工作时长 × 维修人员时薪 = 工时费

### 6. 材料表 (materials)
**用途**: 存储维修用材料和配件的基本信息，支持库存管理
**关键字段**:
- `type`: 材料类型（BATTERY/BODY/BRAKE/ELECTRICAL/FILTER/OIL/OTHER/TIRE）
- `price`: 材料单价
- `stock`: 库存数量

### 7. 维修记录-材料关联表 (record_material)
**用途**: 记录每次维修工作中使用的材料及其数量
**计费逻辑**: 材料单价 × 使用数量 = 材料费

### 8. 维修人员表 (repairmen)
**用途**: 存储维修人员的基本信息和技能类型
**关键字段**:
- `type`: 维修人员类型（APPRENTICE/BODYWORKER/DIAGNOSER/ELECTRICIAN/INSPECTOR/MECHANIC/PAINTER）
- `username`: 登录用户名，唯一约束

### 9. 其他支持表
- **repairman_history**: 维修人员信息变更审计
- **required_repairman_types**: 定义维修项目所需的人员类型和数量
- **salaries**: 不同类型维修人员的时薪标准
- **user_history**: 用户信息变更审计
- **users**: 系统用户（车主）基本信息
- **wages**: 维修人员月度工资结算

## 索引优化说明

### 唯一索引 (UNIQUE)
- `uk_admin_username`: 管理员用户名唯一性
- `uk_car_license_plate`: 车牌号唯一性
- `uk_repairman_username`: 维修人员用户名唯一性
- `uk_user_username`: 用户用户名唯一性

### 普通索引 (INDEX)
- `idx_car_user_id`: 优化根据用户查询车辆
- `idx_maintenance_item_car_id`: 优化根据汽车查询维修记录
- `idx_maintenance_record_item_id`: 优化根据维修项目查询记录
- `idx_repairman_type`: 优化根据维修人员类型查询
- `idx_wage_repairman_id`: 优化根据维修人员查询工资

## 业务触发器

### trg_maintenanceitem_completed
**触发条件**: 维修状态变更为"COMPLETED"
**自动执行**:
1. 汇总工时费用 = SUM(工作时长 × 维修人员时薪)
2. 汇总材料费用 = SUM(材料单价 × 使用数量)
3. 计算总费用 = 工时费 + 材料费
4. 设置完成时间

## 数据完整性约束

### 外键约束
- 确保车辆归属有效用户
- 确保维修项目关联有效车辆
- 确保维修记录关联有效项目和人员
- 确保材料使用记录的完整性
- 确保维修人员类型在薪资标准中存在

### 检查约束
- 维修人员类型值范围检查 (0-6)
- 确保数据值在有效范围内

## 使用说明

1. **主要文件**: `motify_2.sql` - 包含完整的表结构和注释
2. **补充脚本**: `add_table_comments.sql` - 可单独执行的注释添加脚本
3. **字符集**: 统一使用 utf8mb4，支持完整Unicode字符
4. **排序规则**: utf8mb4_0900_ai_ci（不区分大小写和重音）

## 触发器说明

### trg_required_repairman_type_updated 触发器

**功能**: 自动管理维修工单状态转换

**触发时机**: 当 `required_repairman_types` 表发生 UPDATE 操作后

**业务逻辑**:
1. **状态检查**: 只处理状态为 `PENDING`（待处理）或 `ACCEPTED`（已接受）的工单
2. **需求统计**: 统计工单需要的所有工种数量（required > 0）
3. **分配检查**: 统计已满足分配要求的工种数量（assigned >= required）
4. **状态转换**: 当所有工种需求都已满足时，自动将工单状态更新为 `IN_PROGRESS`（进行中）

**核心变量**:
- `v_item_id`: 当前维修工单ID
- `v_total_types`: 该工单需要的工种总数
- `v_fulfilled_types`: 已满足分配要求的工种数量
- `v_current_status`: 当前工单状态

**业务价值**:
- 自动化工单状态管理，减少人工干预
- 确保只有在维修工资源充足时才开始维修
- 提高维修工单流转效率
- 保证数据一致性和业务逻辑正确性

**使用场景**:
- 管理员为工单分配维修工时
- 维修工接受或退出工单时
- 工单需求发生变更时

## 维护建议

1. **定期备份**: 重要的业务数据表建议定期备份
2. **索引监控**: 根据查询模式调整索引策略
3. **触发器监控**: 
   - 监控 `trg_required_repairman_type_updated` 触发器的执行性能
   - 检查触发器是否正确处理边界情况（如并发更新）
   - 定期验证状态转换逻辑的正确性
4. **历史数据**: 定期清理或归档历史记录表数据
5. **约束检查**: 定期检查外键约束的性能影响
6. **触发器测试**: 
   - 测试维修工分配和释放场景
   - 验证状态转换的准确性
   - 确保触发器不会造成死锁或性能问题

